<head>
 <style>
.typing-indicator span {
    animation: typing 1.4s infinite both;
}
.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}
.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}
@keyframes typing {
    0%, 60%, 100% {
    transform: translateY(0);
    }
    30% {
    transform: translateY(-4px);
    }
}
.chat-messages {
    scrollbar-width: thin;
    scrollbar-color: #2d85cd transparent;
}
.chat-messages::-webkit-scrollbar {
    width: 6px;
}
.chat-messages::-webkit-scrollbar-track {
    background: transparent;
}
.chat-messages::-webkit-scrollbar-thumb {
    background-color: #2d85cd;
    border-radius: 3px;
}
  </style>
</head>
  
<!-- Demo content to show the page -->
<div class="p-8">
<h1 class="text-3xl font-display font-bold text-dark dark:text-white mb-4">Welcome to Our Website</h1>
<p class="text-gray-600 dark:text-gray-300 mb-4">This is a demo page with a chatbot. Click the chat icon in the bottom right corner to start chatting!</p>

<!-- Dark mode toggle for demo -->
<button id="darkModeToggle" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
    Toggle Dark Mode
</button>
</div>

<!-- Chatbot Button -->
<button 
id="chatbotButton" 
class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 w-14 h-14 sm:w-16 sm:h-16 bg-primary hover:bg-primary/90 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center z-50 group"
aria-label="Open chat"
>
<!-- Chat Icon -->
<svg id="chatIcon" class="w-7 h-7 sm:w-8 sm:h-8 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
</svg>

<!-- Close Icon (hidden by default) -->
<svg id="closeIcon" class="w-7 h-7 sm:w-8 sm:h-8 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
</svg>

<!-- Unread Badge -->
<span 
    id="unreadBadge" 
    class="absolute -top-1 -right-1 w-5 h-5 sm:w-6 sm:h-6 bg-accent text-white text-xs font-bold rounded-full flex items-center justify-center animate-pulse"
>
    1
</span>
</button>

<!-- Chat Modal -->
<div 
id="chatModal" 
class="fixed bottom-20 right-4 sm:bottom-24 sm:right-6 w-[calc(100vw-2rem)] sm:w-96 h-[70vh] sm:h-[500px] max-h-[600px] bg-white dark:bg-dark rounded-xl shadow-2xl z-50 hidden flex-col overflow-hidden border border-gray-200 dark:border-gray-700 transition-all duration-300 transform scale-95 opacity-0"
>
<!-- Chat Header -->
<div class="bg-primary text-white p-4 flex items-center justify-between shrink-0">
    <div class="flex items-center space-x-3">
    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
        </svg>
    </div>
    <div>
        <h3 class="font-display font-semibold">AI Assistant</h3>
        <p class="text-xs text-white/80">Always here to help</p>
    </div>
    </div>
    <button 
    id="closeModal" 
    class="p-1 hover:bg-white/20 rounded-lg transition-colors"
    aria-label="Close chat"
    >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
    </button>
</div>

<!-- Chat Messages -->
<div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 chat-messages bg-gray-50 dark:bg-background-dark">
    <!-- Messages will be inserted here -->
</div>

<!-- Typing Indicator -->
<div id="typingIndicator" class="hidden px-4 py-2 bg-gray-50 dark:bg-background-dark">
    <div class="flex items-center space-x-2">
    <div class="w-8 h-8 bg-primary/10 dark:bg-primary/20 rounded-full flex items-center justify-center">
        <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
        </svg>
    </div>
    <div class="bg-white dark:bg-dark px-4 py-2 rounded-xl rounded-bl-none shadow-sm">
        <div class="typing-indicator flex space-x-1">
        <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
        <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
        <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
        </div>
    </div>
    </div>
</div>

<!-- Chat Input -->
<div class="p-4 bg-white dark:bg-dark border-t border-gray-200 dark:border-gray-700 shrink-0">
    <form id="chatForm" class="flex items-center space-x-2">
    <input 
        type="text" 
        id="messageInput" 
        placeholder="Type your message..." 
        class="flex-1 px-4 py-2 bg-gray-100 dark:bg-background-dark text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 rounded-lg border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
        autocomplete="off"
    >
    <button 
        type="submit" 
        id="sendButton"
        class="p-2 bg-primary hover:bg-primary/90 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        aria-label="Send message"
    >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
        </svg>
    </button>
    </form>
</div>
</div>

<script>
// Configuration
const DEEPINFRA_API_KEY = 'YOUR_DEEPINFRA_API_KEY'; // Replace with your API key
const DEEPINFRA_API_URL = 'https://api.deepinfra.com/v1/openai/chat/completions';
const MODEL = 'meta-llama/Meta-Llama-3-8B-Instruct';

// DOM Elements
const chatbotButton = document.getElementById('chatbotButton');
const chatModal = document.getElementById('chatModal');
const closeModal = document.getElementById('closeModal');
const chatForm = document.getElementById('chatForm');
const messageInput = document.getElementById('messageInput');
const chatMessages = document.getElementById('chatMessages');
const unreadBadge = document.getElementById('unreadBadge');
const chatIcon = document.getElementById('chatIcon');
const closeIcon = document.getElementById('closeIcon');
const typingIndicator = document.getElementById('typingIndicator');
const sendButton = document.getElementById('sendButton');
const darkModeToggle = document.getElementById('darkModeToggle');

// State
let isOpen = false;
let unreadCount = 1;
let messages = [];
let isLoading = false;

// Initialize with welcome message
const welcomeMessage = {
    role: 'assistant',
    content: 'Hello! ðŸ‘‹ How may I help you today? I\'m here to assist you with any questions you might have.',
    timestamp: new Date()
};
messages.push(welcomeMessage);

// Dark mode toggle
darkModeToggle.addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
});

// Toggle chat modal
function toggleChat() {
    isOpen = !isOpen;
    
    if (isOpen) {
    chatModal.classList.remove('hidden');
    chatModal.classList.add('flex');
    
    // Animate in
    setTimeout(() => {
        chatModal.classList.remove('scale-95', 'opacity-0');
        chatModal.classList.add('scale-100', 'opacity-100');
    }, 10);
    
    // Update icons
    chatIcon.classList.add('hidden');
    closeIcon.classList.remove('hidden');
    
    // Clear unread count
    unreadCount = 0;
    updateBadge();
    
    // Render messages
    renderMessages();
    
    // Focus input
    setTimeout(() => messageInput.focus(), 300);
    } else {
    chatModal.classList.add('scale-95', 'opacity-0');
    chatModal.classList.remove('scale-100', 'opacity-100');
    
    setTimeout(() => {
        chatModal.classList.add('hidden');
        chatModal.classList.remove('flex');
    }, 300);
    
    // Update icons
    chatIcon.classList.remove('hidden');
    closeIcon.classList.add('hidden');
    }
}

// Update badge
function updateBadge() {
    if (unreadCount > 0) {
    unreadBadge.textContent = unreadCount > 9 ? '9+' : unreadCount;
    unreadBadge.classList.remove('hidden');
    } else {
    unreadBadge.classList.add('hidden');
    }
}

// Render messages
function renderMessages() {
    chatMessages.innerHTML = messages.map(msg => createMessageHTML(msg)).join('');
    scrollToBottom();
}

// Create message HTML
function createMessageHTML(message) {
    const isUser = message.role === 'user';
    const time = formatTime(message.timestamp);
    
    if (isUser) {
    return `
        <div class="flex justify-end">
        <div class="max-w-[80%]">
            <div class="bg-primary text-white px-4 py-2 rounded-xl rounded-br-none shadow-sm">
            <p class="text-sm">${escapeHTML(message.content)}</p>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 text-right">${time}</p>
        </div>
        </div>
    `;
    } else {
    return `
        <div class="flex items-start space-x-2">
        <div class="w-8 h-8 bg-primary/10 dark:bg-primary/20 rounded-full flex items-center justify-center shrink-0">
            <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
        </div>
        <div class="max-w-[80%]">
            <div class="bg-white dark:bg-dark px-4 py-2 rounded-xl rounded-bl-none shadow-sm border border-gray-100 dark:border-gray-700">
            <p class="text-sm text-gray-800 dark:text-gray-200">${escapeHTML(message.content)}</p>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${time}</p>
        </div>
        </div>
    `;
    }
}

// Format time
function formatTime(date) {
    return new Date(date).toLocaleTimeString('en-US', { 
    hour: 'numeric', 
    minute: '2-digit',
    hour12: true 
    });
}

// Escape HTML
function escapeHTML(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// Scroll to bottom
function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Show typing indicator
function showTyping() {
    typingIndicator.classList.remove('hidden');
    scrollToBottom();
}

// Hide typing indicator
function hideTyping() {
    typingIndicator.classList.add('hidden');
}

// Send message to DeepInfra API
async function sendToAPI(userMessage) {
    const conversationHistory = messages.map(msg => ({
    role: msg.role,
    content: msg.content
    }));

    try {
    const response = await fetch(DEEPINFRA_API_URL, {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${DEEPINFRA_API_KEY}`
        },
        body: JSON.stringify({
        model: MODEL,
        messages: [
            {
            role: 'system',
            content: 'You are a helpful, friendly, and professional AI assistant. Keep your responses concise and helpful. Be warm and personable while maintaining professionalism.'
            },
            ...conversationHistory
        ],
        max_tokens: 500,
        temperature: 0.7
        })
    });

    if (!response.ok) {
        throw new Error('API request failed');
    }

    const data = await response.json();
    return data.choices[0].message.content;
    } catch (error) {
    console.error('API Error:', error);
    return 'I apologize, but I\'m having trouble connecting right now. Please try again in a moment.';
    }
}

// Handle form submission
async function handleSubmit(e) {
    e.preventDefault();
    
    const content = messageInput.value.trim();
    if (!content || isLoading) return;

    // Add user message
    const userMessage = {
    role: 'user',
    content: content,
    timestamp: new Date()
    };
    messages.push(userMessage);
    renderMessages();
    
    // Clear input
    messageInput.value = '';
    
    // Disable input while loading
    isLoading = true;
    messageInput.disabled = true;
    sendButton.disabled = true;
    
    // Show typing indicator
    showTyping();
    
    // Get AI response
    const aiResponse = await sendToAPI(content);
    
    // Hide typing indicator
    hideTyping();
    
    // Add AI message
    const assistantMessage = {
    role: 'assistant',
    content: aiResponse,
    timestamp: new Date()
    };
    messages.push(assistantMessage);
    
    // Update unread if chat is closed
    if (!isOpen) {
    unreadCount++;
    updateBadge();
    }
    
    renderMessages();
    
    // Re-enable input
    isLoading = false;
    messageInput.disabled = false;
    sendButton.disabled = false;
    messageInput.focus();
}

// Event listeners
chatbotButton.addEventListener('click', toggleChat);
closeModal.addEventListener('click', toggleChat);
chatForm.addEventListener('submit', handleSubmit);

// Close on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isOpen) {
    toggleChat();
    }
});

// Handle enter key in input
messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    chatForm.dispatchEvent(new Event('submit'));
    }
});

// Initialize badge on load
updateBadge();

// Check for system dark mode preference
if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.documentElement.classList.add('dark');
}
</script>